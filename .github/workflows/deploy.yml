name: Deploy to Play Store

on:
  push:
    branches:
      - master

# Need write permission to update repo variables after successful deploy
permissions:
  contents: read
  actions: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Read Version from Repo Variables
        run: |
          echo "APP_VERSION_CODE=${{ vars.VERSION_CODE }}" >> $GITHUB_ENV
          echo "APP_VERSION_NAME=${{ vars.VERSION_NAME }}" >> $GITHUB_ENV
          echo "================================================"
          echo "Building with versionCode: ${{ vars.VERSION_CODE }}"
          echo "Building with versionName: ${{ vars.VERSION_NAME }}"
          echo "================================================"

      - name: Validate Version Code
        run: |
          VC="${{ vars.VERSION_CODE }}"
          if [ -z "$VC" ] || [ "$VC" -lt 18 ]; then
            echo "ERROR: VERSION_CODE is missing or less than 18 (current Play Store min)."
            echo "Please set VERSION_CODE repo variable to a value >= 18."
            exit 1
          fi
          echo "Version code $VC is valid (>= 18)."

      - name: Decode Keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > app/keystore.jks

      - name: Create Play Store JSON Key
        env:
          PLAY_STORE_JSON_KEY: ${{ secrets.PLAY_STORE_JSON_KEY }}
        run: |
          echo "$PLAY_STORE_JSON_KEY" > play-store-key.json

      - name: Build Release AAB
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          ANDROID_KEYSTORE_FILE: keystore.jks
          APP_VERSION_CODE: ${{ vars.VERSION_CODE }}
          APP_VERSION_NAME: ${{ vars.VERSION_NAME }}
          CI: true
        run: ./gradlew bundleRelease

      - name: Verify Build Outputs
        run: |
          echo "=== AAB File ==="
          ls -lh app/build/outputs/bundle/release/*.aab
          echo "=== Mapping File ==="
          ls -lh app/build/outputs/mapping/release/mapping.txt || echo "No mapping file found (minify may be disabled)"
          echo "=== Version ==="
          echo "versionCode: ${{ vars.VERSION_CODE }}"
          echo "versionName: ${{ vars.VERSION_NAME }}"

      - name: Upload to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: play-store-key.json
          packageName: com.yourname.pdftoolkit
          releaseFiles: app/build/outputs/bundle/release/*.aab
          track: internal
          status: completed
          mappingFile: app/build/outputs/mapping/release/mapping.txt
          whatsNewDirectory: distribution/whatsnew

      # Only runs if upload succeeded â€” increment version for next build
      - name: Increment Version Code
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_VC=${{ vars.VERSION_CODE }}
          NEXT_VC=$((CURRENT_VC + 1))
          gh variable set VERSION_CODE --body "$NEXT_VC"
          echo "Version code incremented: $CURRENT_VC -> $NEXT_VC"

      - name: Increment Version Name
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          CURRENT_VN="${{ vars.VERSION_NAME }}"
          # Split version name by dots, increment patch number
          MAJOR=$(echo "$CURRENT_VN" | cut -d. -f1)
          MINOR=$(echo "$CURRENT_VN" | cut -d. -f2)
          PATCH=$(echo "$CURRENT_VN" | cut -d. -f3)
          NEXT_PATCH=$((PATCH + 1))
          NEXT_VN="${MAJOR}.${MINOR}.${NEXT_PATCH}"
          gh variable set VERSION_NAME --body "$NEXT_VN"
          echo "Version name incremented: $CURRENT_VN -> $NEXT_VN"
