name: Deploy to Play Store & Indus App Store

on:
  push:
    branches:
      - master

# Write permission needed to push VERSION, VERSION_HISTORY.md updates
permissions:
  contents: write
  actions: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for commit log generation

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Calculate Version Code and Read Version Name
        run: |
          # --- VERSION CODE ---
          # Use the VERSION_CODE file as the source of truth.
          # If missing, default to 31 (since 30 and 31 are already used).
          if [ -f VERSION_CODE ]; then
            NEW_VERSION_CODE=$(cat VERSION_CODE | tr -d '[:space:]')
          else
            echo "No VERSION_CODE file found. Defaulting to 32."
            NEW_VERSION_CODE=32
          fi
          
          # --- VERSION NAME ---
          # Read from the VERSION file committed in the repo.
          if [ -f VERSION ]; then
            VERSION_NAME=$(cat VERSION | tr -d '[:space:]')
          else
            echo "No VERSION file found. Defaulting to 1.3.5."
            VERSION_NAME="1.3.5"
          fi
          
          echo "VERSION_CODE=$NEW_VERSION_CODE" >> $GITHUB_ENV
          echo "APP_VERSION_CODE=$NEW_VERSION_CODE" >> $GITHUB_ENV
          echo "APP_VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          
          echo "================================================"
          echo "Building with versionCode: $NEW_VERSION_CODE"
          echo "Building with versionName: $VERSION_NAME"
          echo "================================================"

      - name: Generate Release Notes
        id: generate-notes
        run: |
          # Extract the latest commit message for release metadata
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          COMMIT_HASH=$(git log -1 --pretty=format:"%h")
          BUILD_DATE=$(date -u +"%Y-%m-%d")
          
          # Write to release_description.txt (artifact-level description)
          cat > release_description.txt <<EOF
          Build: v${{ env.APP_VERSION_NAME }} (code ${{ env.APP_VERSION_CODE }})
          Date:  ${BUILD_DATE}
          Commit: ${COMMIT_HASH}
          
          ${COMMIT_MSG}
          EOF
          
          # Update whatsnew for Play Store listing
          cat > distribution/whatsnew/whatsnew-en-US <<EOF
          Bug fixes and improvements for PDF viewer zoom functionality
          
          • Fixed zoom controls visibility issues
          • Improved pinch-to-zoom gesture handling
          • Enhanced PDF viewer performance and stability
          EOF
          
          # Set output for GitHub Release
          echo "release_notes<<EOF" >> $GITHUB_OUTPUT
          cat distribution/whatsnew/whatsnew-en-US >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          echo "=== Release Description ==="
          cat release_description.txt
          echo ""
          echo "=== What's New ==="
          cat distribution/whatsnew/whatsnew-en-US

      - name: Decode Keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > app/keystore.jks

      - name: Create Play Store JSON Key
        env:
          PLAY_STORE_JSON_KEY: ${{ secrets.PLAY_STORE_JSON_KEY }}
        run: |
          echo "$PLAY_STORE_JSON_KEY" > play-store-key.json

      - name: Make gradlew executable
        run: chmod +x gradlew

      - name: Build Release AAB
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          ANDROID_KEYSTORE_FILE: keystore.jks
          VERSION_CODE: ${{ env.VERSION_CODE }}
          APP_VERSION_CODE: ${{ env.APP_VERSION_CODE }}
          APP_VERSION_NAME: ${{ env.APP_VERSION_NAME }}
          CI: true
        run: ./gradlew bundleRelease

      - name: Verify Build Outputs
        run: |
          echo "=== AAB File ==="
          ls -lh app/build/outputs/bundle/release/*.aab
          echo "=== Mapping File ==="
          ls -lh app/build/outputs/mapping/release/mapping.txt || echo "No mapping file found (minify may be disabled)"
          echo "=== Native Debug Symbols ==="
          ls -lh app/build/outputs/native-debug-symbols/release/native-debug-symbols.zip || echo "No native debug symbols zip found"
          echo "=== Version ==="
          echo "versionCode: ${{ env.APP_VERSION_CODE }}"
          echo "versionName: ${{ env.APP_VERSION_NAME }}"

      - name: Upload to Play Store
        id: upload-play-store
        continue-on-error: true
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: play-store-key.json
          packageName: com.yourname.pdftoolkit
          releaseFiles: app/build/outputs/bundle/release/*.aab
          track: internal
          status: completed
          mappingFile: app/build/outputs/mapping/release/mapping.txt
          debugSymbols: app/build/intermediates/merged_native_libs/release/mergeReleaseNativeLibs/out/lib
          whatsNewDirectory: distribution/whatsnew

      - name: Upload to Indus App Store
        id: upload-indus-store
        continue-on-error: true
        run: |
          AAB_FILE="app/build/outputs/bundle/release/PDFToolkit-v${{ env.APP_VERSION_NAME }}-release.aab"
          KEYSTORE_FILE="app/keystore.jks"
          
          echo "Uploading to Indus App Store..."
          echo "AAB File: $AAB_FILE"
          
          # Create multipart form data request
          RESPONSE=$(curl -X POST \
            "https://developer-api.indusappstore.com/devtools/aab/upgrade/com.yourname.pdftoolkit" \
            -H "Authorization: ${{ secrets.INDUS_APP_STORE_KEY }}" \
            -F "file=@${AAB_FILE}" \
            -F "file=@${KEYSTORE_FILE}" \
            -F "keyPassword=${{ secrets.KEY_PASSWORD }}" \
            -F "keystoreAlias=${{ secrets.KEY_ALIAS }}" \
            -F "keystorePassword=${{ secrets.KEYSTORE_PASSWORD }}" \
            -w "\n%{http_code}" \
            -s)
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "HTTP Status: $HTTP_CODE"
          echo "Response: $BODY"
          
          if [ "$HTTP_CODE" -ge 200 ] && [ "$HTTP_CODE" -lt 300 ]; then
            echo "✓ Successfully uploaded to Indus App Store"
            exit 0
          else
            echo "✗ Failed to upload to Indus App Store"
            echo "Response body: $BODY"
            exit 1
          fi

      - name: Check Deployment Results
        run: |
          echo "=== Deployment Summary ==="
          echo "Play Store: ${{ steps.upload-play-store.outcome }}"
          echo "Indus App Store: ${{ steps.upload-indus-store.outcome }}"
          
          # Fail the job only if BOTH deployments failed
          if [[ "${{ steps.upload-play-store.outcome }}" == "failure" && "${{ steps.upload-indus-store.outcome }}" == "failure" ]]; then
            echo "ERROR: Both store deployments failed!"
            exit 1
          fi
          
          if [[ "${{ steps.upload-play-store.outcome }}" == "failure" ]]; then
            echo "WARNING: Play Store deployment failed, but Indus App Store succeeded"
          fi
          
          if [[ "${{ steps.upload-indus-store.outcome }}" == "failure" ]]; then
            echo "WARNING: Indus App Store deployment failed, but Play Store succeeded"
          fi
          
          echo "At least one deployment succeeded - proceeding with version increment"

      - name: Create GitHub Release
        if: success()
        uses: softprops/action-gh-release@v1
        with:
          tag_name: v${{ env.APP_VERSION_NAME }}
          name: Release v${{ env.APP_VERSION_NAME }}
          body: |
            ## PDF Toolkit v${{ env.APP_VERSION_NAME }} (Build ${{ env.APP_VERSION_CODE }})
            
            ### What's New
            ${{ steps.generate-notes.outputs.release_notes }}
            
            ### Deployment Status
            - Play Store: ${{ steps.upload-play-store.outcome == 'success' && '✅ Deployed' || '❌ Failed' }}
            - Indus App Store: ${{ steps.upload-indus-store.outcome == 'success' && '✅ Deployed' || '❌ Failed' }}
            
            ### Build Info
            - Version Code: ${{ env.APP_VERSION_CODE }}
            - Version Name: ${{ env.APP_VERSION_NAME }}
            - Min SDK: 26 (Android 8.0)
            - Target SDK: 35 (Android 15)
          files: |
            app/build/outputs/bundle/release/*.aab
            app/build/outputs/mapping/release/mapping.txt
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Only runs if at least one upload succeeded — increment VERSION, VERSION_CODE, and update history
      - name: Increment Version and Update History
        if: success()
        run: |
          BUILD_DATE=$(date -u +"%Y-%m-%d")
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          
          # --- Increment VERSION_CODE for next build ---
          CURRENT_CODE="${{ env.APP_VERSION_CODE }}"
          NEXT_CODE=$(( CURRENT_CODE + 1 ))
          echo "$NEXT_CODE" > VERSION_CODE
          echo "Updated VERSION_CODE: $CURRENT_CODE -> $NEXT_CODE"
          
          # --- Increment VERSION_NAME (patch bump) for next build ---
          CURRENT_VN="${{ env.APP_VERSION_NAME }}"
          MAJOR=$(echo "$CURRENT_VN" | cut -d. -f1)
          MINOR=$(echo "$CURRENT_VN" | cut -d. -f2)
          PATCH=$(echo "$CURRENT_VN" | cut -d. -f3)
          NEXT_PATCH=$((PATCH + 1))
          NEXT_VN="${MAJOR}.${MINOR}.${NEXT_PATCH}"
          echo "$NEXT_VN" > VERSION
          echo "Updated VERSION: $CURRENT_VN -> $NEXT_VN"
          
          # --- Append to VERSION_HISTORY.md ---
          echo "| $CURRENT_CODE           | $CURRENT_VN       | ${BUILD_DATE} | ${COMMIT_MSG} |" >> VERSION_HISTORY.md
          
          # --- Configure git and push ---
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add VERSION VERSION_CODE VERSION_HISTORY.md distribution/whatsnew/whatsnew-en-US
          git commit -m "ci: deployed v${CURRENT_VN} (code ${CURRENT_CODE}) → next: v${NEXT_VN} (code ${NEXT_CODE})" || echo "No changes to commit"
          git push origin master || echo "Push failed — version update skipped"
