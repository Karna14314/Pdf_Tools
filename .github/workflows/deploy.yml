name: Deploy to Play Store

on:
  push:
    branches:
      - master

# Write permission needed to push VERSION_HISTORY.md and update repo variables
permissions:
  contents: write
  actions: write

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for commit log generation

      - name: Set up JDK 17
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: gradle

      - name: Configure Version Code and Name
        run: |
          # Retrieve the last Version Code from GitHub Variables
          # If not set (first run), default to 30 so the next one is 31.
          LAST_CODE="${{ vars.APP_VERSION_CODE }}"
          if [ -z "$LAST_CODE" ]; then
            echo "No APP_VERSION_CODE variable found. Defaulting to 30."
            LAST_CODE=30
          fi
          
          # Increment to get the new code for this build
          NEW_VERSION_CODE=$(( LAST_CODE + 1 ))
          
          # Read Version Name from repo vars (or default to 1.3.5 if missing)
          VERSION_NAME="${{ vars.VERSION_NAME }}"
          if [ -z "$VERSION_NAME" ]; then VERSION_NAME="1.3.5"; fi
          
          echo "APP_VERSION_CODE=$NEW_VERSION_CODE" >> $GITHUB_ENV
          echo "APP_VERSION_NAME=$VERSION_NAME" >> $GITHUB_ENV
          
          echo "================================================"
          echo "Building with versionCode: $NEW_VERSION_CODE"
          echo "Building with versionName: $VERSION_NAME"
          echo "================================================"

      - name: Generate Release Notes
        run: |
          # Extract the latest commit message for release metadata
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          COMMIT_HASH=$(git log -1 --pretty=format:"%h")
          BUILD_DATE=$(date -u +"%Y-%m-%d")
          
          # Write to release_description.txt (artifact-level description)
          cat > release_description.txt <<EOF
          Build: v${{ env.APP_VERSION_NAME }} (code ${{ env.APP_VERSION_CODE }})
          Date:  ${BUILD_DATE}
          Commit: ${COMMIT_HASH}
          
          ${COMMIT_MSG}
          EOF
          
          # Update whatsnew for Play Store listing
          cat > distribution/whatsnew/whatsnew-en-US <<EOF
          v${{ env.APP_VERSION_NAME }} - ${COMMIT_MSG}
          
          • Latest improvements and bug fixes
          • Android 15 (16 KB page alignment) compatible
          • Enhanced performance and stability
          EOF
          
          echo "=== Release Description ==="
          cat release_description.txt
          echo ""
          echo "=== What's New ==="
          cat distribution/whatsnew/whatsnew-en-US

      - name: Decode Keystore
        env:
          ANDROID_KEYSTORE_BASE64: ${{ secrets.ANDROID_KEYSTORE_BASE64 }}
        run: |
          echo "$ANDROID_KEYSTORE_BASE64" | base64 --decode > app/keystore.jks

      - name: Create Play Store JSON Key
        env:
          PLAY_STORE_JSON_KEY: ${{ secrets.PLAY_STORE_JSON_KEY }}
        run: |
          echo "$PLAY_STORE_JSON_KEY" > play-store-key.json

      - name: Build Release AAB
        env:
          KEYSTORE_PASSWORD: ${{ secrets.KEYSTORE_PASSWORD }}
          KEY_ALIAS: ${{ secrets.KEY_ALIAS }}
          KEY_PASSWORD: ${{ secrets.KEY_PASSWORD }}
          ANDROID_KEYSTORE_FILE: keystore.jks
          APP_VERSION_CODE: ${{ env.APP_VERSION_CODE }}
          APP_VERSION_NAME: ${{ env.APP_VERSION_NAME }}
          CI: true
        run: ./gradlew bundleRelease

      - name: Verify Build Outputs
        run: |
          echo "=== AAB File ==="
          ls -lh app/build/outputs/bundle/release/*.aab
          echo "=== Mapping File ==="
          ls -lh app/build/outputs/mapping/release/mapping.txt || echo "No mapping file found (minify may be disabled)"
          echo "=== Version ==="
          echo "versionCode: ${{ env.APP_VERSION_CODE }}"
          echo "versionName: ${{ env.APP_VERSION_NAME }}"

      - name: Upload to Play Store
        uses: r0adkll/upload-google-play@v1
        with:
          serviceAccountJson: play-store-key.json
          packageName: com.yourname.pdftoolkit
          releaseFiles: app/build/outputs/bundle/release/*.aab
          track: internal
          status: completed
          mappingFile: app/build/outputs/mapping/release/mapping.txt
          whatsNewDirectory: distribution/whatsnew

      # Only runs if upload succeeded — increment VERSION_NAME & CODE for next build
      - name: Increment Version Name & Code
        if: success()
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # 1. Update Version Code (Save the one we just used)
          NEW_CODE="${{ env.APP_VERSION_CODE }}"
          gh variable set APP_VERSION_CODE --body "$NEW_CODE"
          echo "Updated APP_VERSION_CODE variable to $NEW_CODE"

          # 2. Increment Version Name for next time
          CURRENT_VN="${{ env.APP_VERSION_NAME }}"
          MAJOR=$(echo "$CURRENT_VN" | cut -d. -f1)
          MINOR=$(echo "$CURRENT_VN" | cut -d. -f2)
          PATCH=$(echo "$CURRENT_VN" | cut -d. -f3)
          NEXT_PATCH=$((PATCH + 1))
          NEXT_VN="${MAJOR}.${MINOR}.${NEXT_PATCH}"
          
          gh variable set VERSION_NAME --body "$NEXT_VN"
          echo "Updated VERSION_NAME variable: $CURRENT_VN -> $NEXT_VN"

      - name: Update VERSION_HISTORY.md
        if: success()
        run: |
          BUILD_DATE=$(date -u +"%Y-%m-%d")
          COMMIT_MSG=$(git log -1 --pretty=format:"%s")
          
          # Append the new version entry to VERSION_HISTORY.md
          echo "| ${{ env.APP_VERSION_CODE }}           | ${{ env.APP_VERSION_NAME }}       | ${BUILD_DATE} | ${COMMIT_MSG} |" >> VERSION_HISTORY.md
          
          # Configure git for the commit
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Commit and push the updated VERSION_HISTORY.md and whatsnew
          git add VERSION_HISTORY.md distribution/whatsnew/whatsnew-en-US
          git commit -m "ci: update VERSION_HISTORY.md and release notes [v${{ env.APP_VERSION_NAME }}, code ${{ env.APP_VERSION_CODE }}]" || echo "No changes to commit"
          git push origin master || echo "Push failed — VERSION_HISTORY.md update skipped"
